<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Editar Atendimento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

  <h3 class="mb-4">‚úèÔ∏è Editar Atendimento #{{ comunicacao.id }}</h3>
  <form method="POST">

    <h5>üìû Dados da Comunica√ß√£o</h5>
    <div class="row g-2">
      <div class="col-md-4"><label>Nome</label><input type="text" name="nome" class="form-control" value="{{ comunicacao.nome }}"></div>
      <div class="col-md-4"><label>CPF</label><input type="text" name="cpf" class="form-control" value="{{ comunicacao.cpf }}"></div>
      <div class="col-md-4"><label>Telefone</label><input type="text" name="telefone" class="form-control" value="{{ comunicacao.telefone }}"></div>
      <div class="col-md-4"><label>Endere√ßo</label><input type="text" name="endereco" class="form-control" value="{{ comunicacao.endereco }}"></div>
      <div class="col-md-2"><label>Bairro</label><input type="text" name="bairro" class="form-control" value="{{ comunicacao.bairro }}"></div>
      <div class="col-md-2"><label>N√∫mero</label><input type="text" name="numero" class="form-control" value="{{ comunicacao.numero }}"></div>
      <div class="col-md-2">
        <label>Comunicado</label>
        <select name="comunicado" class="form-select">
          <option value="Presencial" {% if comunicacao.comunicado == 'Presencial' %}selected{% endif %}>Presencial</option>
          <option value="Panfleto" {% if comunicacao.comunicado == 'Panfleto' %}selected{% endif %}>Panfleto</option>
          <option value="Telefone/Whatsapp" {% if comunicacao.comunicado == 'Telefone/Whatsapp' %}selected{% endif %}>Telefone/Whatsapp</option>
        </select>
      </div>
      <div class="col-md-2"><label>Economia</label><input type="text" name="economia" class="form-control" value="{{ comunicacao.economia }}"></div>
      <div class="col-md-2">
        <label>Tipo Im√≥vel</label>
        <select name="tipo_imovel" class="form-select">
          <option value="Casa" {% if comunicacao.tipo_imovel == 'Casa' %}selected{% endif %}>Casa</option>
          <option value="Com√©rcio" {% if comunicacao.tipo_imovel == 'Com√©rcio' %}selected{% endif %}>Com√©rcio</option>
          <option value="Mix" {% if comunicacao.tipo_imovel == 'Mix' %}selected{% endif %}>Mix</option>
          <option value="Templo Religioso" {% if comunicacao.tipo_imovel == 'Templo Religioso' %}selected{% endif %}>Templo Religioso</option>
          <option value="Escola" {% if comunicacao.tipo_imovel == 'Escola' %}selected{% endif %}>Escola</option>
          <option value="Terreno/Constru√ß√£o" {% if comunicacao.tipo_imovel == 'Terreno/Constru√ß√£o' %}selected{% endif %}>Terreno/Constru√ß√£o</option>
          <option value="Sal√£o/Garagem" {% if comunicacao.tipo_imovel == 'Sal√£o/Garagem' %}selected{% endif %}>Sal√£o/Garagem</option>
        </select>
      </div>
      <div class="col-md-4"><label>Assinatura</label><input type="text" name="assinatura" class="form-control" value="{{ comunicacao.assinatura }}"></div>
      <div class="col-md-4">
        <label>Obra</label>
        <select name="obra_id" class="form-select">
          {% for obra in obras %}
            <option value="{{ obra.id }}" {% if comunicacao.obra_id == obra.id %}selected{% endif %}>{{ obra.nome }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <hr>
    <h5>üìÖ Tentativas</h5>
    <div class="row g-2">
      <div class="col-md-3"><label>Data 1</label><input type="date" name="data_1" class="form-control" value="{{ vistoria.data_1 }}"></div>
      <div class="col-md-3"><label>Hora 1</label><input type="time" name="hora_1" class="form-control" value="{{ vistoria.hora_1 }}"></div>
      <div class="col-md-3"><label>Data 2</label><input type="date" name="data_2" class="form-control" value="{{ vistoria.data_2 }}"></div>
      <div class="col-md-3"><label>Hora 2</label><input type="time" name="hora_2" class="form-control" value="{{ vistoria.hora_2 }}"></div>
      <div class="col-md-3"><label>Data 3</label><input type="date" name="data_3" class="form-control" value="{{ vistoria.data_3 }}"></div>
      <div class="col-md-3"><label>Hora 3</label><input type="time" name="hora_3" class="form-control" value="{{ vistoria.hora_3 }}"></div>
    </div>
    <h5>üèòÔ∏è Dados da Vistoria</h5>
    <div class="row g-2">
      <div class="col-md-4">
        <label>Uso</label>
        <select name="uso" class="form-select">
          <option value="residencial" {% if vistoria.uso == 'residencial' %}selected{% endif %}>Residencial</option>
          <option value="comercial" {% if vistoria.uso == 'comercial' %}selected{% endif %}>Comercial</option>
          <option value="misto" {% if vistoria.uso == 'misto' %}selected{% endif %}>Misto</option>
        </select>
      </div>
      <!-- <div class="col-md-4"><label>Nome Respons√°vel</label><input type="text" name="nome_responsavel" class="form-control" value="{{ vistoria.nome_responsavel }}"></div>
      <div class="col-md-4"><label>CPF Respons√°vel</label><input type="text" name="cpf_responsavel" class="form-control" value="{{ vistoria.cpf_responsavel }}"></div>
      <div class="col-md-4"><label>Tipo V√≠nculo</label><input type="text" name="tipo_vinculo" class="form-control" value="{{ vistoria.tipo_vinculo }}"></div>
      <div class="col-md-3"><label>Munic√≠pio</label><input type="text" name="municipio" class="form-control" value="{{ vistoria.municipio }}"></div>
      <div class="col-md-3"><label>Bairro</label><input type="text" name="bairro" class="form-control" value="{{ vistoria.bairro }}"></div>
      <div class="col-md-3"><label>Rua</label><input type="text" name="rua" class="form-control" value="{{ vistoria.rua }}"></div>
      <div class="col-md-2"><label>N√∫mero</label><input type="text" name="numero_vistoria" class="form-control" value="{{ vistoria.numero }}"></div>
      <div class="col-md-2"><label>Complemento</label><input type="text" name="complemento" class="form-control" value="{{ vistoria.complemento }}"></div>
      <div class="col-md-2"><label>Celular</label><input type="text" name="celular" class="form-control" value="{{ vistoria.celular }}"></div> -->
      <div class="col-md-3"><label>Tipo Im√≥vel</label><input type="text" name="tipo_imovel" class="form-control" value="{{ vistoria.tipo_imovel }}"></div>
      <div class="col-md-2">
        <label>Soleira</label>
        <select name="soleira" class="form-select">
          <option value="positiva" {% if vistoria.soleira == 'positiva' %}selected{% endif %}>Positiva</option>
          <option value="negativa" {% if vistoria.soleira == 'negativa' %}selected{% endif %}>Negativa</option>
        </select>
      </div>
      <div class="col-md-3">
        <label>Cal√ßada</label>
        <select name="calcada" class="form-select">
          <option value="cimento" {% if vistoria.calcada == 'cimento' %}selected{% endif %}>Cimento</option>
          <option value="revestimento" {% if vistoria.calcada == 'revestimento' %}selected{% endif %}>Revestimento</option>
          <option value="sem acabamento" {% if vistoria.calcada == 'sem acabamento' %}selected{% endif %}>Sem acabamento</option>
        </select>
      </div>
      <div class="col-12"><label>Observa√ß√µes</label><textarea name="observacoes" class="form-control" rows="3">{{ vistoria.observacoes }}</textarea></div>
      <div class="col-12 mb-3">
  <label>Assinatura do Morador</label>
  <div class="border p-2 bg-white">
    <canvas id="signature-pad" width="400" height="150" style="border:1px solid #ccc;"></canvas>
  </div>
  <input type="hidden" id="assinatura_base64" name="assinatura_base64" value="{{ vistoria.assinatura_base64 }}">
  <div class="mt-2">
    <button type="button" class="btn btn-sm btn-danger" onclick="clearSignature()">Limpar</button>
  </div>
  {% if vistoria.assinatura_base64 %}
    <p class="mt-2">Assinatura anterior:</p>
    <img src="{{ vistoria.assinatura_base64 }}" alt="Assinatura" style="max-width:100%; border:1px solid #ccc;">
  {% endif %}
</div>


    <hr>
    

    <hr>
    <button type="submit" class="btn btn-success">Salvar Altera√ß√µes</button>
    <a href="{{ url_for('atendimento.dashboard_unificado') }}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>
<script>
  const canvas = document.getElementById('signature-pad');
  const input = document.getElementById('assinatura_base64');
  const ctx = canvas.getContext('2d');
  let isDrawing = false;

  canvas.addEventListener('mousedown', () => { isDrawing = true });
  canvas.addEventListener('mouseup', () => {
    isDrawing = false;
    input.value = canvas.toDataURL();
  });
  canvas.addEventListener('mouseout', () => isDrawing = false);
  canvas.addEventListener('mousemove', draw);

  function draw(e) {
    if (!isDrawing) return;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
  }

  function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    input.value = "";
  }
</script>

</body>
</html>
