<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vistorias & Comunicações</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
</head>
<body class="bg-light p-3 p-md-4">
  <div class="container bg-white p-4 rounded shadow">

    <!-- Título + botão voltar -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h3 class="mb-0 text-primary"><i class="bi bi-clipboard-data"></i> Vistorias & Comunicações</h3>
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
      </a>
    </div>

    <!-- Botão Novo Atendimento -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        <a href="/atendimento/nova" class="btn btn-outline-success square-button w-100">
          <i class="bi bi-file-earmark-plus"></i>
          Novo Atendimento
        </a>
      </div>
    </div>



    <!-- Filtro -->
    <div class="input-group mb-4">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text" class="form-control" id="filtroBusca" placeholder="Buscar por nome, rua, obra...">
    </div>

    <!-- Cards resumo -->
    <div class="row text-center mb-4">
      <div class="col-md-4 col-12 mb-2">
        <div class="card border-success">
          <div class="card-body">
            <h5 class="card-title text-success">Comunicações</h5>
            <h3>{{ total_comunicacoes }}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-4 col-12 mb-2">
        <div class="card border-primary">
          <div class="card-body">
            <h5 class="card-title text-primary">Vistorias</h5>
            <h3>{{ total_vistorias }}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-4 col-12 mb-2">
        <div class="card border-dark">
          <div class="card-body">
            <h5 class="card-title text-dark">Total Registros</h5>
            <h3>{{ total_registros }}</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela -->
    {% if registros %}
    <div class="table-responsive">
      <table class="table table-hover align-middle text-center" id="tabelaRegistros">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Rua</th>
            <th>Obra</th>
            <th>Data</th>
            <th>Status</th>
            {% if session.cargo == 'admin' %}
            <th>Ações</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for r in registros %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.nome or 'Sem nome' }}</td>
            <td>{{ r.rua }}</td>
            <td>{{ r.obra.nome if r.obra else '—' }}</td>
            <td>
              {{ r.data_envio.strftime('%d/%m/%Y') if r.data_envio else (r.data_1.strftime('%d/%m/%Y') if r.data_1 else '') }}
            </td>
            <td>
              {% if r.finalizada %}
                <span class="badge bg-success">Finalizada</span>
              {% else %}
                <span class="badge bg-warning text-dark">Em andamento</span>
              {% endif %}
            </td>
            {% if session.cargo == 'admin' %}
            <td>
              <a href="{{ url_for('editar_registro_unificado', id=r.id) }}" class="btn btn-sm btn-primary">
                <i class="bi bi-pencil-square"></i>
              </a>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p class="text-muted text-center mt-4">Nenhum registro encontrado ainda.</p>
    {% endif %}
  </div>

  <script>
    // Filtro de busca por texto
    document.getElementById("filtroBusca").addEventListener("keyup", function () {
      const filtro = this.value.toLowerCase();
      const linhas = document.querySelectorAll("#tabelaRegistros tbody tr");

      linhas.forEach((linha) => {
        const texto = linha.textContent.toLowerCase();
        linha.style.display = texto.includes(filtro) ? "" : "none";
      });
    });
  </script>
</body>
</html>
