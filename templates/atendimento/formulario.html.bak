<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Formul√°rio Unificado - Comunica√ß√£o & Vistoria</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light p-3">
  <div class="container bg-white p-4 rounded shadow">
    <h3 class="mb-4">üìã Formul√°rio Unificado de Atendimento</h3>

    <!-- Obra -->
    <div class="mb-4">
      {% if session.cargo == 'admin' %}
        <label class="form-label">Vincular a Obra</label>
        <select name="obra_id" class="form-select" required>
          <option value="">Selecione uma obra...</option>
          {% for obra in obras %}
            <option value="{{ obra.id }}" {% if vistoria.obra_id == obra.id %}selected{% endif %}>
              {{ obra.nome }} - {{ obra.bairro }}
            </option>
          {% endfor %}
        </select>
      {% else %}
        <input type="hidden" name="obra_id" value="{{ session.obra_id }}">
        <div class="alert alert-secondary">
          <i class="bi bi-info-circle"></i> Esta comunica√ß√£o est√° vinculada √† obra:
          <strong>{{ vistoria.obra.nome if vistoria.obra else 'Obra n√£o encontrada' }}</strong>
        </div>
      {% endif %}
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-success">{{ messages[0] }}</div>
      {% endif %}
    {% endwith %}

    <form method="POST" enctype="multipart/form-data">

      <!-- COMUNICADOR -->
      {% if session.cargo in ['comunicador', 'admin'] %}
      <h5 class="mb-3">üë§ Dados do Morador</h5>
      <div class="row">
        <div class="col-md-6 mb-3"><label>Nome</label><input type="text" name="nome" class="form-control" value="{{ comunicacao.nome or '' }}" required></div>
        <div class="col-md-6 mb-3"><label>Telefone</label><input type="tel" name="telefone" class="form-control" value="{{ comunicacao.telefone or '' }}"></div>
        <div class="col-md-6 mb-3"><label>CPF</label><input type="text" name="cpf" class="form-control" value="{{ comunicacao.cpf or '' }}"></div>
        <div class="col-md-6 mb-3">
          <label>Comunicado via</label>
          <select name="comunicado" class="form-select">
            <option value="impresso" {% if comunicacao.comunicado == 'impresso' %}selected{% endif %}>Impresso</option>
            <option value="whatsapp" {% if comunicacao.comunicado == 'whatsapp' %}selected{% endif %}>WhatsApp</option>
            <option value="telefone" {% if comunicacao.comunicado == 'telefone' %}selected{% endif %}>Telefone</option>
          </select>
        </div>
        <div class="col-md-6 mb-3"><label>Endere√ßo</label><input type="text" name="endereco" class="form-control" value="{{ comunicacao.endereco or '' }}" required></div>
        <div class="col-md-6 mb-3"><label>Tipo de Im√≥vel</label><input type="text" name="tipo_imovel" class="form-control" value="{{ comunicacao.tipo_imovel or '' }}"></div>
        <div class="col-md-6 mb-3"><label>Economia</label><input type="text" name="economia" class="form-control" value="{{ comunicacao.economia or '' }}"></div>
      </div>
      {% endif %}

      <!-- VISTORIADOR -->
      {% if session.cargo in ['vistoriador', 'admin'] %}
      <h5 class="mt-4 mb-3">üîç Tentativas de Vistoria</h5>
      {% for i in range(1, 4) %}
        <div class="row mb-2">
          <div class="col-md-6">
            <label>Data {{ i }}¬™ tentativa</label>
            <input type="date" name="data_{{ i }}" class="form-control" value="{{ vistoria|getattr_safe('data_' ~ i|string) }}">
          </div>
          <div class="col-md-6">
            <label>Hora {{ i }}¬™ tentativa</label>
            <input type="time" name="hora_{{ i }}" class="form-control" value="{{ vistoria|getattr_safe('hora_' ~ i|string) }}">
          </div>
        </div>
      {% endfor %}

      <!-- üìç Campos extras -->
      <h5 class="mt-4 mb-3">üèòÔ∏è Dados do Im√≥vel</h5>
      <div class="row">
        <div class="col-md-4 mb-3"><label>Munic√≠pio</label><input type="text" name="municipio" class="form-control" value="{{ vistoria.municipio or '' }}"></div>
        <div class="col-md-4 mb-3"><label>Complemento</label><input type="text" name="complemento" class="form-control" value="{{ vistoria.complemento or '' }}"></div>
        <div class="col-md-4 mb-3"><label>Celular</label><input type="tel" name="celular" class="form-control" value="{{ vistoria.celular or '' }}"></div>
      </div>

      <div class="mb-3">
        <label class="form-label">Soleira</label><br>
        <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="soleira" value="positiva" {% if vistoria.soleira == 'positiva' %}checked{% endif %}> Positiva</div>
        <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="soleira" value="negativa" {% if vistoria.soleira == 'negativa' %}checked{% endif %}> Negativa</div>
      </div>

      <div class="mb-3">
        <label class="form-label">Cal√ßada</label><br>
        <div class="form-check"><input class="form-check-input" type="checkbox" name="calcada_cimento" value="1" {% if vistoria.calcada_cimento %}checked{% endif %}> Cimento</div>
        <div class="form-check"><input class="form-check-input" type="checkbox" name="calcada_revestimento" value="1" {% if vistoria.calcada_revestimento %}checked{% endif %}> Revestimento</div>
        <div class="form-check"><input class="form-check-input" type="checkbox" name="calcada_sem_acabamento" value="1" {% if vistoria.calcada_sem_acabamento %}checked{% endif %}> Sem acabamento</div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3"><label>Respons√°vel</label><input type="text" name="nome_responsavel" class="form-control" value="{{ vistoria.nome_responsavel or '' }}"></div>
        <div class="col-md-6 mb-3"><label>CPF/RG</label><input type="text" name="cpf_responsavel" class="form-control" value="{{ vistoria.cpf_responsavel or '' }}"></div>
      </div>

      <div class="mb-3">
        <label class="form-label">Tipo de V√≠nculo</label><br>
        <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="tipo_vinculo" value="proprietario" {% if vistoria.tipo_vinculo == 'proprietario' %}checked{% endif %}> Propriet√°rio</div>
        <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="tipo_vinculo" value="inquilino" {% if vistoria.tipo_vinculo == 'inquilino' %}checked{% endif %}> Inquilino</div>
        <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="tipo_vinculo" value="responsavel" {% if vistoria.tipo_vinculo == 'responsavel' %}checked{% endif %}> Respons√°vel</div>
      </div>

      <!-- Observa√ß√µes -->
      <div class="mb-3">
        <label>Observa√ß√µes</label>
        <textarea name="observacoes" class="form-control">{{ vistoria.observacoes or '' }}</textarea>
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" name="finalizada" value="1" id="finalizada" {% if vistoria.finalizada %}checked{% endif %}>
        <label class="form-check-label" for="finalizada">Vistoria finalizada</label>
      </div>

      <!-- üì∏ Fotos j√° cadastradas -->
      {% if vistoria.fotos %}
      <h5 class="mt-4 mb-3">üì∏ Fotos j√° cadastradas</h5>
      <div class="row mb-4">
        {% for foto in vistoria.fotos %}
        <div class="col-md-4 text-center mb-3">
          <img src="{{ foto.url }}" alt="Foto {{ loop.index }}" class="img-thumbnail" style="max-height: 200px;">
          <p class="small mt-2">{{ foto.descricao or 'Sem descri√ß√£o' }}</p>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- üì∑ Upload -->
      <h5 class="mt-4">üì∑ Novas Fotos da Vistoria</h5>
      <div id="container-fotos">
        <div class="row mb-3">
          <div class="col-md-6"><input type="file" name="fotos[]" class="form-control"></div>
          <div class="col-md-6"><input type="text" name="descricao_fotos[]" class="form-control" placeholder="Descri√ß√£o da foto"></div>
        </div>
      </div>
      <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="adicionarFoto()">+ Adicionar outra foto</button>
      <script>
        function adicionarFoto() {
          const container = document.getElementById("container-fotos");
          const novo = document.createElement("div");
          novo.classList.add("row", "mb-3");
          novo.innerHTML = `
            <div class="col-md-6"><input type="file" name="fotos[]" class="form-control"></div>
            <div class="col-md-6"><input type="text" name="descricao_fotos[]" class="form-control" placeholder="Descri√ß√£o da foto"></div>`;
          container.appendChild(novo);
        }
      </script>
      {% endif %}

      <!-- Bot√µes -->
      <div class="d-flex justify-content-between mt-4">
        <a href="{{ url_for('dashboard_unificado') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Voltar</a>
        <button type="submit" class="btn btn-success"><i class="bi bi-check-circle"></i> Salvar</button>
      </div>
    </form>
  </div>
</body>
</html>
