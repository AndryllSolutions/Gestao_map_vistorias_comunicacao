<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Formul√°rio Unificado - Comunica√ß√£o & Vistoria</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="bg-light p-3">
  <div class="container bg-white p-4 rounded shadow">
    <h3 class="mb-4">üìã Formul√°rio Unificado de Atendimento</h3>

{% if comunicacao.usuario or vistoria.usuario %}
<div class="alert alert-light border d-flex flex-column gap-1 small">
  {% if comunicacao.usuario %}
    <div>
      <i class="bi bi-person-badge-fill text-primary"></i>
      <strong>Comunicador:</strong>
      <span class="badge bg-primary">{{ comunicacao.usuario.nome }}</span>
    </div>
  {% endif %}
  {% if vistoria.usuario %}
    <div>
      <i class="bi bi-person-video3 text-warning"></i>
      <strong>Vistoriador:</strong>
      <span class="badge bg-warning text-dark">{{ vistoria.usuario.nome }}</span>
    </div>
  {% endif %}
</div>
{% endif %}
{% if session.cargo == 'vistoriador' and vistoria and not vistoria.usuario %}
  <form method="POST" action="{{ url_for('atendimento.assumir_vistoria', id=vistoria.id) }}" class="mb-3">
    <button type="submit" class="btn btn-outline-warning w-100">
      <i class="bi bi-person-plus"></i> üìå Assumir esta Vistoria
    </button>
  </form>
{% endif %}
    <!-- ‚úÖ Corrigido: agora o formul√°rio POSTA para a pr√≥pria rota (criar ou editar) -->
    <form method="POST" 
      action="{% if vistoria and vistoria.id %}{{ url_for('atendimento.atendimento_unificado', id=vistoria.id) }}{% else %}{{ url_for('atendimento.criar_atendimento') }}{% endif %}" 
      enctype="multipart/form-data">

      <div class="mb-4">
        <label class="form-label">Vincular a Obra</label>
        <select name="obra_id" class="form-select" {% if session.cargo == 'vistoriador' %}disabled{% endif %} required>
          <option value="">Selecione uma obra...</option>
          {% for obra in obras %}
          <option value="{{ obra.id }}" {% if vistoria.obra_id==obra.id %}selected{% endif %}>
            {{ obra.nome }} - {{ obra.bairro }}
          </option>
          {% endfor %}
        </select>
        <!-- Hidden input necess√°rio se o campo estiver desabilitado -->
        {% if session.cargo == 'vistoriador' and vistoria.obra_id %}
  <input type="hidden" name="obra_id" value="{{ vistoria.obra_id }}">
{% endif %}

      </div>

      <h5 class="mb-3">üë§ Dados do Morador</h5>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label>Nome</label>
          <input type="text" name="nome" class="form-control" value="{{ comunicacao.nome or '' }}" {% if session.cargo=='vistoriador' %}readonly{% endif %} required>
        </div>
        <div class="col-md-6 mb-3">
          <label>CPF / RG</label>
          <input type="text" name="cpf" class="form-control" value="{{ comunicacao.cpf or '' }}" {% if session.cargo=='vistoriador' %}readonly{% endif %}>
        </div>
        <div class="col-md-6 mb-3">
          <label>Telefone</label>
          <input type="tel" name="telefone" class="form-control" value="{{ comunicacao.telefone or '' }}" {% if session.cargo=='vistoriador' %}readonly{% endif %}>
        </div>
        <div class="col-md-6 mb-3">
          <label>Endere√ßo (Rua / Av)</label>
          <input type="text" name="endereco" class="form-control" value="{{ comunicacao.endereco or '' }}" {% if session.cargo=='vistoriador' %}readonly{% endif %} required>
        </div>
        <div class="col-md-3 mb-3">
          <label>N√∫mero</label>
          <input type="text" name="numero" class="form-control" value="{{ comunicacao.numero or '' }}" {% if session.cargo=='vistoriador' %}readonly{% endif %}>
        </div>
        <div class="col-md-3 mb-3">
          <label>Bairro</label>
          <input type="text" name="bairro" class="form-control" value="{{ comunicacao.bairro or '' }}" {% if session.cargo=='vistoriador' %}readonly{% endif %}>
        </div>
        <div class="col-md-6 mb-3">
          <label>Comunicado via</label>
          <select name="comunicado" class="form-select" {% if session.cargo=='vistoriador' %}disabled{% endif %}>
            <option value="impresso" {% if comunicacao.comunicado=='impresso' %}selected{% endif %}>Impresso</option>
            <option value="whatsapp" {% if comunicacao.comunicado=='whatsapp' %}selected{% endif %}>WhatsApp</option>
            <option value="telefone" {% if comunicacao.comunicado=='telefone' %}selected{% endif %}>Telefone</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label>Economia</label>
          <input type="text" name="economia" class="form-control" value="{{ comunicacao.economia or '' }}" {% if session.cargo=='vistoriador' %}readonly{% endif %}>
        </div>
        <div class="col-md-12 mb-3">
          <label>Tipo de Im√≥vel</label><br>
          {% set tipo = comunicacao.tipo_imovel %}
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="tipo_imovel" value="residencial" {% if tipo=='residencial' %}checked{% endif %} {% if session.cargo=='vistoriador' %}disabled{% endif %}>
            <label class="form-check-label">Residencial</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="tipo_imovel" value="comercial" {% if tipo=='comercial' %}checked{% endif %} {% if session.cargo=='vistoriador' %}disabled{% endif %}>
            <label class="form-check-label">Comercial</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="tipo_imovel" value="misto" {% if tipo=='misto' %}checked{% endif %} {% if session.cargo=='vistoriador' %}disabled{% endif %}>
            <label class="form-check-label">Misto</label>
          </div>
        </div>
      </div>

      {% if session.cargo in ['vistoriador', 'admin'] %}
      <h5 class="mt-4 mb-3">üîç Tentativas de Vistoria</h5>
      {% for i in range(1, 4) %}
      <div class="row mb-2">
        <div class="col-md-6">
          <label>Data {{ i }}¬™ tentativa</label>
          <input type="date" name="data_{{ i }}" class="form-control" value="{{ vistoria | getattr('data_' ~ i) or '' }}">
        </div>
        <div class="col-md-6">
          <label>Hora {{ i }}¬™ tentativa</label>
          <input type="time" name="hora_{{ i }}" class="form-control" value="{{ vistoria | getattr('hora_' ~ i) or '' }}">
        </div>
      </div>
      {% endfor %}

      <h5 class="mt-4 mb-3">üì∏ Fotos da Vistoria</h5>
      <div id="container-fotos">
        <div class="row mb-3">
          <div class="col-md-6"><input type="file" name="fotos[]" class="form-control"></div>
          <div class="col-md-6"><input type="text" name="descricao_fotos[]" class="form-control" placeholder="Descri√ß√£o da foto"></div>
        </div>
      </div>
      <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="adicionarFoto()">+ Adicionar outra foto</button>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" name="finalizada" value="1" id="finalizada" {% if vistoria.finalizada %}checked{% endif %}>
        <label class="form-check-label" for="finalizada">Vistoria finalizada</label>
      </div>
      {% endif %}

      <div class="d-flex justify-content-between mt-4">
        <a href="{{ url_for('atendimento.dashboard_unificado') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Voltar
        </a>
        {% if session.cargo in ['admin', 'vistoriador'] %}
<h5 class="mt-4 mb-3">‚úçÔ∏è Assinatura do Morador</h5>
<div class="mb-3">
  <canvas id="signature" width="400" height="150" class="border border-dark rounded w-100" style="touch-action: none;"></canvas>
  <input type="hidden" name="assinatura" id="assinatura">
</div>
<div class="mb-3 d-flex gap-2">
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limparAssinatura()">Limpar</button>
</div>
{% endif %}
       <button type="submit" class="btn btn-success" onclick="this.disabled=true; this.innerHTML='Salvando...'; this.form.submit();">

  <i class="bi bi-check-circle"></i> Salvar
</button>
      </div>
    </form>
  </div>

  <script>
    function adicionarFoto() {
      const container = document.getElementById("container-fotos");
      const novo = document.createElement("div");
      novo.classList.add("row", "mb-3");
      novo.innerHTML = `
        <div class="col-md-6"><input type="file" name="fotos[]" class="form-control"></div>
        <div class="col-md-6"><input type="text" name="descricao_fotos[]" class="form-control" placeholder="Descri√ß√£o da foto"></div>`;
      container.appendChild(novo);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const agora = new Date().toLocaleString("en-US", { timeZone: "America/Sao_Paulo" });
      const dataBrasilia = new Date(agora);
      for (let i = 1; i <= 3; i++) {
        const dataInput = document.querySelector(`input[name="data_${i}"]`);
        const horaInput = document.querySelector(`input[name="hora_${i}"]`);
        if (dataInput && !dataInput.value) dataInput.value = dataBrasilia.toISOString().slice(0, 10);
        if (horaInput && !horaInput.value) horaInput.value = dataBrasilia.toTimeString().slice(0, 5);
      }
    });
  </script>
</body>
</html>
