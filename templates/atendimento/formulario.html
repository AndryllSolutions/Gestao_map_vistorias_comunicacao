{% import 'components/macros.html' as macros %}

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Formul√°rio Unificado - Comunica√ß√£o & Vistoria</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light p-3">
<div class="container bg-white p-4 rounded shadow">
  <h3 class="mb-4">üìã Formul√°rio Unificado de Atendimento</h3>

  {% if comunicacao.usuario or vistoria.usuario %}
  <div class="alert alert-light border d-flex flex-column gap-1 small">
    {% if comunicacao.usuario %}
    <div>
      <i class="bi bi-person-badge-fill text-primary"></i>
      <strong>Comunicador:</strong>
      <span class="badge bg-primary">{{ comunicacao.usuario.nome }}</span>
    </div>
    {% endif %}
    {% if vistoria.usuario %}
    <div>
      <i class="bi bi-person-video3 text-warning"></i>
      <strong>Vistoriador:</strong>
      <span class="badge bg-warning text-dark">{{ vistoria.usuario.nome }}</span>
    </div>
    {% endif %}
  </div>
  {% endif %}

  {% if session.cargo == 'vistoriador' and vistoria and not vistoria.usuario %}
  <form method="POST" action="{{ url_for('atendimento.assumir_vistoria', id=vistoria.id) }}" class="mb-3">
    <button type="submit" class="btn btn-outline-warning w-100">
      <i class="bi bi-person-plus"></i> üìå Assumir esta Vistoria
    </button>
  </form>
  {% endif %}

  <form method="POST"
        action="{% if vistoria and vistoria.id %}{{ url_for('atendimento.atendimento_unificado', id=vistoria.id) }}{% else %}{{ url_for('atendimento.criar_atendimento') }}{% endif %}"
        enctype="multipart/form-data"
        autocomplete="off">

    <!-- Obra -->
    <div class="mb-4">
      <label for="obra_id" class="form-label">Vincular a Obra</label>
      <select name="obra_id" id="obra_id" class="form-select" {% if session.cargo == 'vistoriador' %}disabled{% endif %} required>
        <option value="">Selecione uma obra...</option>
        {% for obra in obras %}
        <option value="{{ obra.id }}" {% if vistoria.obra_id == obra.id %}selected{% endif %}>
          {{ obra.nome }} - {{ obra.bairro }}
        </option>
        {% endfor %}
      </select>
      {% if session.cargo == 'vistoriador' and vistoria.obra_id %}
      <input type="hidden" name="obra_id" value="{{ vistoria.obra_id }}">
      {% endif %}
    </div>

    <!-- Dados do Morador -->
    <!-- COMUNICA√á√ÉO - DADOS DO MORADOR -->
<h5 class="mb-3"><i class="bi bi-person-fill"></i> Dados do Morador</h5>
<div class="row">
  <div class="col-md-6 mb-3">
    <label for="nome">Nome</label>
    {{ macros.input_readonly_com_hidden('nome', vistoria.nome_responsavel or comunicacao.nome or '', session.cargo == 'vistoriador') }}
  </div>
  <div class="col-md-6 mb-3">
    <label for="cpf">CPF / RG</label>
    {{ macros.input_readonly_com_hidden('cpf', vistoria.cpf_responsavel or comunicacao.cpf or '', session.cargo == 'vistoriador') }}
  </div>
  <div class="col-md-6 mb-3">
    <label for="telefone">Telefone</label>
    {{ macros.input_readonly_com_hidden('telefone', comunicacao.telefone or '', session.cargo == 'vistoriador') }}
  </div>
  <div class="col-md-6 mb-3">
    <label for="endereco">Endere√ßo (Rua / Av)</label>
    {{ macros.input_readonly_com_hidden('endereco', vistoria.rua or comunicacao.endereco or '', session.cargo == 'vistoriador') }}
  </div>
  <div class="col-md-3 mb-3">
    <label for="numero">N√∫mero</label>
    {{ macros.input_readonly_com_hidden('numero', vistoria.numero or comunicacao.numero or '', session.cargo == 'vistoriador') }}
  </div>
  <div class="col-md-3 mb-3">
    <label for="bairro">Bairro</label>
    {{ macros.input_readonly_com_hidden('bairro', vistoria.bairro or comunicacao.bairro or '', session.cargo == 'vistoriador') }}
  </div>
  <div class="col-md-6 mb-3">
    <label for="comunicado">Comunicado via</label>
    {% if session.cargo == 'vistoriador' %}
      {{ macros.input_readonly_com_hidden('comunicado', comunicacao.comunicado or '', True) }}
    {% else %}
      <select name="comunicado" class="form-select" id="comunicado">
        <option value="impresso" {% if comunicacao.comunicado == 'impresso' %}selected{% endif %}>Impresso</option>
        <option value="whatsapp" {% if comunicacao.comunicado == 'whatsapp' %}selected{% endif %}>WhatsApp</option>
        <option value="telefone" {% if comunicacao.comunicado == 'telefone' %}selected{% endif %}>Telefone</option>
      </select>
    {% endif %}
  </div>
  <div class="col-md-6 mb-3">
    <label for="economia">Economia</label>
    {{ macros.input_readonly_com_hidden('economia', comunicacao.economia or '', session.cargo == 'vistoriador') }}
  </div>
</div>

{% if session.cargo in ['admin', 'vistoriador'] %}
<!-- VISTORIA - TENTATIVAS -->
<h5 class="mt-4 mb-3">üìÖ Tentativas de Vistoria</h5>
<div class="row">
  {% for i in range(1, 4) %}
  <div class="col-md-3 mb-3">
    <label for="data_{{ i }}">Tentativa {{ i }} - Data</label>
<input type="date" class="form-control" name="data_{{ i }}" id="data_{{ i }}" value="{{ vistoria | attr('data_' ~ i) or '' }}">

  </div>
  <div class="col-md-3 mb-3">
    <label for="hora_{{ i }}">Tentativa {{ i }} - Hora</label>
<input type="time" class="form-control" name="hora_{{ i }}" id="hora_{{ i }}" value="{{ vistoria | attr('hora_' ~ i) or '' }}">
  </div>
  {% endfor %}
</div>

<!-- VISTORIA - RESPONS√ÅVEL -->
<h5 class="mb-3">üë§ Respons√°vel pelas Informa√ß√µes</h5>
<div class="row">
  <div class="col-md-6 mb-3">
  <label for="vinculo_select">V√≠nculo com o im√≥vel</label>

    <select name="vinculo" id="vinculo_select" class="form-select" onchange="mostrarOutroCampo()">
  <option value="">-- Selecione --</option>
  <option value="Propriet√°rio" {% if vistoria.tipo_vinculo == 'Propriet√°rio' %}selected{% endif %}>Propriet√°rio</option>
  <option value="Inquilino" {% if vistoria.tipo_vinculo == 'Inquilino' %}selected{% endif %}>Inquilino</option>
  <option value="Respons√°vel legal" {% if vistoria.tipo_vinculo == 'Respons√°vel legal' %}selected{% endif %}>Respons√°vel legal</option>
  <option value="Representante autorizado" {% if vistoria.tipo_vinculo == 'Representante autorizado' %}selected{% endif %}>Representante autorizado</option>
  <option value="S√≠ndico" {% if vistoria.tipo_vinculo == 'S√≠ndico' %}selected{% endif %}>S√≠ndico</option>
  <option value="Outro" {% if vistoria.tipo_vinculo and vistoria.tipo_vinculo not in ['Propriet√°rio', 'Inquilino', 'Respons√°vel legal', 'Representante autorizado', 'S√≠ndico'] %}selected{% endif %}>Outro</option>
</select>

<!-- Campo oculto para "Outro" -->
<div id="vinculo_outro_div" class="mt-2" style="display: none;">
  <input type="text" class="form-control" name="vinculo_outro" id="vinculo_outro" placeholder="Especifique o v√≠nculo" value="{% if vistoria.tipo_vinculo and vistoria.tipo_vinculo not in ['Propriet√°rio', 'Inquilino', 'Respons√°vel legal', 'Representante autorizado', 'S√≠ndico'] %}{{ vistoria.tipo_vinculo }}{% endif %}">
</div>
  </div>
  <div class="col-md-6 mb-3">
    <label>Tipo de respons√°vel</label><br>
    {% set r = vistoria.responsavel_info %}
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="responsavel_info" value="proprietario" {% if r == 'proprietario' %}checked{% endif %}>
      <label class="form-check-label">Propriet√°rio</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="responsavel_info" value="inquilino" {% if r == 'inquilino' %}checked{% endif %}>
      <label class="form-check-label">Inquilino</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="responsavel_info" value="outro" {% if r == 'outro' %}checked{% endif %}>
      <label class="form-check-label">Outro</label>
    </div>
  </div>
</div>

<!-- VISTORIA - SITUA√á√ÉO DO IM√ìVEL -->
<h5 class="mt-4 mb-3">üèòÔ∏è Situa√ß√£o do Im√≥vel</h5>
<div class="row">
  <div class="col-md-6 mb-3">
    <label class="form-label">Soleira</label><br>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="soleira" value="positiva" {% if vistoria.soleira == 'positiva' %}checked{% endif %}>
      <label class="form-check-label">Positiva</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="soleira" value="negativa" {% if vistoria.soleira == 'negativa' %}checked{% endif %}>
      <label class="form-check-label">Negativa</label>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <label class="form-label">Tipo de Cal√ßada</label><br>
    {% for valor, rotulo in [('cimento', 'Cimento'), ('revestimento', 'Revestimento'), ('sem_acabamento', 'Sem acabamento')] %}
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="calcada" value="{{ valor }}" {% if vistoria.calcada == valor %}checked{% endif %}>
      <label class="form-check-label">{{ rotulo }}</label>
    </div>
    {% endfor %}
  </div>
</div>
<!-- Tipo de Uso do Im√≥vel -->
<div class="mb-3">
  <label class="form-label">Uso do Im√≥vel</label><br>
  {% set uso = vistoria.uso or '' %}
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="uso" id="uso_residencial" value="residencial" {% if uso == 'residencial' %}checked{% endif %}>
    <label class="form-check-label" for="uso_residencial">Residencial</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="uso" id="uso_comercial" value="comercial" {% if uso == 'comercial' %}checked{% endif %}>
    <label class="form-check-label" for="uso_comercial">Comercial</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="uso" id="uso_misto" value="misto" {% if uso == 'misto' %}checked{% endif %}>
    <label class="form-check-label" for="uso_misto">Misto</label>
  </div>
</div>

<!-- VISTORIA - OBSERVA√á√ïES -->
<div class="mb-3">
  <label for="observacoes">üìù Observa√ß√µes Gerais</label>
  <textarea name="observacoes" id="observacoes" class="form-control" rows="3">{{ vistoria.observacoes or '' }}</textarea>
</div>
{% if session.cargo in ['admin', 'vistoriador'] %}
<div class="mb-3">
  <label for="fotos" class="form-label">üì∑ Fotos da Vistoria</label>
  <input type="file" class="form-control" id="fotos" name="fotos" multiple accept="image/*">
  <small class="form-text text-muted">Voc√™ pode selecionar v√°rias fotos de uma vez.</small>
</div>

{% endif %}
{% if vistoria and vistoria.fotos %}
  <div class="mt-3">
    <label class="form-label">üìÅ Fotos j√° enviadas</label>
    <div class="row">
      {% for foto in vistoria.fotos %}
      <div class="col-6 col-md-4 mb-3">
        <div class="card shadow-sm">
          <img src="{{ foto.url }}" class="card-img-top" alt="{{ foto.titulo }}" style="height: 180px; object-fit: cover;">
          <div class="card-body p-2">
            <p class="card-text small text-truncate mb-1">{{ foto.titulo }}</p>
            {% if session.cargo in ['admin', 'vistoriador'] %}
              <form method="POST" action="{{ url_for('fotos.excluir_foto', foto_id=foto.id) }}" onsubmit="return confirm('Tem certeza que deseja excluir esta foto?')">
                <button type="submit" class="btn btn-sm btn-outline-danger w-100"><i class="bi bi-trash"></i> Excluir</button>
              </form>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

<!-- VISTORIA - ASSINATURA -->
<h5 class="mt-4 mb-3">‚úçÔ∏è Assinatura do Morador</h5>
<div class="mb-3">
  <canvas id="signature" width="400" height="150" class="border border-dark rounded w-100" style="touch-action: none;"></canvas>
  <input type="hidden" name="assinatura" id="assinatura">
  <small class="form-text text-muted">Utilize o dedo ou mouse para assinar.</small>
</div>
<div class="mb-3 d-flex gap-2">
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limparAssinatura()">Limpar</button>
</div>
{% endif %}
<div class="d-flex justify-content-between mt-4">
  <a href="{{ url_for('atendimento.dashboard_unificado') }}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left"></i> Voltar
  </a>
  <button type="submit" class="btn btn-success" onclick="this.disabled=true; this.innerHTML='Salvando...'; this.form.submit();">
    <i class="bi bi-check-circle"></i> Salvar
  </button>
  <!-- LOCALIZA√á√ÉO (GPS) -->
<h5 class="mt-4 mb-3">üìç Localiza√ß√£o (GPS)</h5>
<div class="row g-2 align-items-end" id="gps-bloco">
  <div class="col-12 col-md-3">
    <label class="form-label">Latitude</label>
    <input type="text" class="form-control" id="gps_lat" name="gps_lat" readonly>
  </div>
  <div class="col-12 col-md-3">
    <label class="form-label">Longitude</label>
    <input type="text" class="form-control" id="gps_lng" name="gps_lng" readonly>
  </div>
  <div class="col-6 col-md-2">
    <label class="form-label">Precis√£o (m)</label>
    <input type="text" class="form-control" id="gps_acc" name="gps_acc" readonly>
  </div>
  <div class="col-6 col-md-4">
    <label class="form-label">Coletado em</label>
    <input type="text" class="form-control" id="gps_ts" name="gps_ts" readonly>
  </div>
  <div class="col-12 d-flex gap-2 mt-2">
    <button type="button" class="btn btn-outline-primary" id="btnGPS">
      <i class="bi bi-geo-alt"></i> Usar GPS do aparelho
    </button>
    <small class="text-muted" id="gps_status" aria-live="polite"></small>
  </div>
</div>

</div>
<script>
function limparAssinatura() {
  const canvas = document.getElementById("signature");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}
</script>
<script>
function mostrarOutroCampo() {
  const select = document.getElementById("vinculo_select");
  const outroDiv = document.getElementById("vinculo_outro_div");

  if (select.value === "Outro") {
    outroDiv.style.display = "block";
  } else {
    outroDiv.style.display = "none";
  }
}

// Garante exibi√ß√£o correta ao recarregar a p√°gina com valor preenchido
document.addEventListener("DOMContentLoaded", function () {
  mostrarOutroCampo();
});
</script>
<script>
// ‚Äî‚Äî‚Äî Assinatura: desenho mouse/toque e salva em base64 ‚Äî‚Äî‚Äî
(() => {
  const canvas = document.getElementById("signature");
  if (!canvas) return;
  const ctx = canvas.getContext("2d", { willReadFrequently: true });
  const hidden = document.getElementById("assinatura");

  let desenhando = false;
  let ultimo = null;

  function pos(ev){
    const r = canvas.getBoundingClientRect();
    const x = (ev.touches ? ev.touches[0].clientX : ev.clientX) - r.left;
    const y = (ev.touches ? ev.touches[0].clientY : ev.clientY) - r.top;
    return {x, y};
  }

  function begin(ev){ desenhando = true; ultimo = pos(ev); ev.preventDefault(); }
  function move(ev){
    if (!desenhando) return;
    const p = pos(ev);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    ctx.beginPath();
    ctx.moveTo(ultimo.x, ultimo.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    ultimo = p;
    hidden.value = canvas.toDataURL("image/png");
    ev.preventDefault();
  }
  function end(){ desenhando = false; ultimo = null; }

  // mouse
  canvas.addEventListener('mousedown', begin);
  canvas.addEventListener('mousemove', move);
  ['mouseup','mouseleave'].forEach(e => canvas.addEventListener(e, end));
  // touch
  canvas.addEventListener('touchstart', begin, {passive:false});
  canvas.addEventListener('touchmove',  move,  {passive:false});
  canvas.addEventListener('touchend',   end);

  // limpar
  window.limparAssinatura = function(){
    ctx.clearRect(0,0,canvas.width, canvas.height);
    hidden.value = "";
  };

  // garantia: se tiver rabisco e o hidden vazio, salvar ao submeter
  document.addEventListener('submit', (e) => {
    if (!hidden.value) {
      try { hidden.value = canvas.toDataURL("image/png"); } catch(_) {}
    }
  }, true);
})();
</script>
<script>
// ‚Äî‚Äî‚Äî GPS: captura com alta precis√£o e preenche o formul√°rio ‚Äî‚Äî‚Äî
(() => {
  const btn = document.getElementById('btnGPS');
  if (!btn) return;

  const lat = document.getElementById('gps_lat');
  const lng = document.getElementById('gps_lng');
  const acc = document.getElementById('gps_acc');
  const ts  = document.getElementById('gps_ts');
  const status = document.getElementById('gps_status');

  function msg(t){ if(status){ status.textContent = t; } }

  btn.addEventListener('click', () => {
    if (!navigator.geolocation){
      msg('‚ö†Ô∏è Geolocaliza√ß√£o n√£o suportada neste navegador.');
      return;
    }
    msg('‚è≥ Obtendo posi√ß√£o‚Ä¶ autorize o GPS.');
    btn.disabled = true;

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude, accuracy } = pos.coords;
        const when = new Date(pos.timestamp);

        lat.value = latitude.toFixed(6);
        lng.value = longitude.toFixed(6);
        acc.value = Math.round(accuracy);
        ts.value  = when.toLocaleString();

        msg('‚úÖ Localiza√ß√£o capturada.');
        btn.disabled = false;
      },
      (err) => {
        const map = {
          1: 'Permiss√£o negada.',
          2: 'Posi√ß√£o indispon√≠vel.',
          3: 'Tempo esgotado.'
        };
        msg(`‚ùå Falhou: ${map[err.code] || err.message}`);
        btn.disabled = false;
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 10000 }
    );
  });
})();
</script>

</body>
</html>
