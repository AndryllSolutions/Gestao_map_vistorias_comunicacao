<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vistorias & Comunicações</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body.dark-mode {
        background-color: #1e1e1e !important;
        color: #f0f0f0;
      }

      .dark-mode .container-fluid {
        background-color: #2c2c2c !important;
        color: #f0f0f0;
      }

      .dark-mode .form-control,
      .dark-mode .form-select,
      .dark-mode .table {
        background-color: #3c3c3c;
        color: #fff;
        border-color: #555;
      }

      .dark-mode .table-light {
        background-color: #444 !important;
      }

      .dark-mode .btn-outline-secondary {
        color: #ccc;
        border-color: #666;
      }

      .dark-mode .btn-outline-secondary:hover {
        background-color: #555;
        color: #fff;
      }

      .toggle-theme {
        cursor: pointer;
        font-size: 1.4rem;
      }

      .square-button {
        aspect-ratio:
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 10px;
        border-radius: 12px;
        transition: all 0.2s ease-in-out;
      }
    </style>
  </head>

  <body class="bg-light p-2 p-md-4">
    <div class="container-fluid bg-white p-4 rounded shadow">
      <!-- Título + botão voltar -->
      <div
        class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2"
      >
        <h3 class="mb-0 text-primary">
          <i class="bi bi-clipboard-data"></i> Vistorias & Comunicações
        </h3>
        <div class="d-flex gap-2 align-items-center">
          <i
            class="bi bi-moon toggle-theme"
            title="Alternar modo escuro"
            onclick="toggleTheme()"
          ></i>
          <a
            href="{{ url_for('auth.dashboard') }}"
            class="btn btn-outline-secondary"
          >
            <i class="bi bi-arrow-left"></i>
            <span class="d-none d-sm-inline">Voltar</span>
          </a>
        </div>
      </div>

      <!-- Botão Novo Atendimento -->
      <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-md-3">
          <a
            href="/atendimento/nova"
            class="btn btn-outline-success square-button w-100"
          >
            <i class="bi bi-file-earmark-plus"></i>
            <span class="d-none d-sm-inline">Novo Atendimento</span>
          </a>
        </div>
      </div>

      <!-- Filtro -->
      <form class="row g-2 mb-4" onsubmit="aplicarFiltro(); return false;">
        <div class="col-12 col-md-9">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input
              type="text"
              class="form-control"
              id="filtroBusca"
              placeholder="Buscar por nome, rua, obra..."
              oninput="aplicarFiltroAoDigitar()"
            />
          </div>
        </div>
        <div class="col-12 col-md-3">
          <button type="submit" class="btn btn-outline-primary w-100">
            <i class="bi bi-funnel-fill"></i> Filtrar
          </button>
        </div>
      </form>

      <!-- Cards resumo -->
      <div class="row text-center mb-4">
        <div class="col-12 col-sm-6 col-md-4 mb-3">
          <div class="card border-success h-100">
            <div class="card-body">
              <h5 class="card-title text-success">Comunicações</h5>
              <h3>{{ total_comunicacoes }}</h3>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-md-4 mb-3">
          <div class="card border-primary h-100">
            <div class="card-body">
              <h5 class="card-title text-primary">Vistorias</h5>
              <h3>{{ total_vistorias }}</h3>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4 mb-3">
          <div class="card border-dark h-100">
            <div class="card-body">
              <h5 class="card-title text-dark">Total Registros</h5>
              <h3>{{ total_registros }}</h3>
            </div>
          </div>
        </div>
      </div>
      {% if registros %}

      <div class="table-responsive">
        <table
          class="table table-hover align-middle text-center"
          id="tabelaRegistros"
        >
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>Comunicador</th>
              <th>Vistoriador</th>
              <th class="d-none d-sm-table-cell">Rua</th>
              <th class="d-none d-md-table-cell">Obra</th>
              <!-- Tentativas -->
              <th class="text-nowrap">1ª Tentativa</th>
              <th class="text-nowrap">2ª Tentativa</th>
              <th class="text-nowrap">3ª Tentativa</th>
              <th class="text-nowrap">Status</th>
              {% if session.cargo in ['admin', 'vistoriador'] %}
              <th class="text-nowrap">Ações</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for r in registros %}
            <tr>
              <td>{{ r.id }}</td>
              <td>{{ r.nome }}</td>
              <td>{{ r.comunicador }}</td>
              <td>{{ r.vistoriador }}</td>
              <td class="d-none d-sm-table-cell">{{ r.rua }}</td>
              <td class="d-none d-md-table-cell">
                {{ r.obra.nome if r.obra else "—" }}
              </td>

              <!-- 1ª tentativa -->
              <td>
                {% if r.data_envio %} {{ r.data_envio.strftime('%d/%m/%Y %H:%M')
                }} {% else %} — {% endif %}
              </td>
              <!-- 2ª tentativa -->
              <td>
                {% if r.segunda_tentativa %} {{
                r.segunda_tentativa.strftime('%d/%m/%Y %H:%M') }} {% else %} —
                {% endif %}
              </td>
              <!-- 3ª tentativa -->
              <td>
                {% if r.terceira_tentativa %} {{
                r.terceira_tentativa.strftime('%d/%m/%Y %H:%M') }} {% else %} —
                {% endif %}
              </td>

              <!-- Status -->
              <td>
                {% if r.finalizada %}
                <span class="badge bg-success">Finalizado</span>
                {% else %}
                <span class="badge bg-warning text-dark">Em aberto</span>
                {% endif %}
              </td>

              {% if session.cargo in ['admin', 'vistoriador'] %}
              <!-- Ações -->
              <td>
                <a
                  href="{{ url_for('atendimento.gerar_laudo_weasy', id=r.id) }}"
                  class="btn btn-sm btn-outline-danger"
                ><!-- estou forçando um commit para corrigir o erro do azure.
                -->
                  <i class="bi bi-file-earmark-pdf"></i>
                </a>

                <a
                  href="{{ url_for('atendimento.gerar_excel_vistoria', id=r.id) }}"
                  class="btn btn-sm btn-outline-success"
                >
                  <i class="bi bi-file-earmark-excel"></i>
                </a>
                <a
                  href="{{ url_for('atendimento.editar_atendimento', id=r.id) }}"
                  class="btn btn-sm btn-outline-primary"
                >
                  <i class="bi bi-pencil"></i>
                </a>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% else %}
      <p class="text-muted text-center mt-4">
        Nenhum registro encontrado ainda.
      </p>
      {% endif %}
    </div>

    <script>
      function aplicarFiltroAoDigitar() {
        const termo = document
          .getElementById("filtroBusca")
          .value.toLowerCase();

        document.querySelectorAll("#tabelaRegistros tbody tr").forEach((tr) => {
          const textoLinha = tr.textContent.toLowerCase();
          tr.style.display = textoLinha.includes(termo) ? "" : "none";
        });
      }
    </script>

    <script>
      function aplicarFiltro() {
        const termo = document
          .getElementById("filtroBusca")
          .value.toLowerCase();

        document.querySelectorAll("#tabelaRegistros tbody tr").forEach((tr) => {
          const texto = tr.textContent.toLowerCase();
          tr.style.display = texto.includes(termo) ? "" : "none";
        });
      }

      function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        const isDark = document.body.classList.contains("dark-mode");
        localStorage.setItem("modoEscuro", isDark);
        document.querySelector(".toggle-theme").className = isDark
          ? "bi bi-sun toggle-theme"
          : "bi bi-moon toggle-theme";
      }

      window.addEventListener("DOMContentLoaded", () => {
        const isDark = localStorage.getItem("modoEscuro") === "true";
        if (isDark) {
          document.body.classList.add("dark-mode");
          document.querySelector(".toggle-theme").className =
            "bi bi-sun toggle-theme";
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
