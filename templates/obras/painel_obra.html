{% extends "obras/base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Painel da Obra: {{ obra.nome }}</h2>
  <p><strong>Responsável:</strong> {{ obra.responsavel }}</p>
  <p><strong>Endereço:</strong> {{ obra.endereco }}</p>
  <hr />

  <!-- Checklist -->
  <h5 class="mb-3">✅ Etapas concluídas</h5>
  <ul class="list-group mb-4">
    <li class="list-group-item d-flex justify-content-between align-items-center">
      Comunicação feita
      <span class="badge bg-{{ comunicacoes|length > 0 and 'success' or 'secondary' }}">
        {{ '✔️' if comunicacoes|length > 0 else '❌' }}
      </span>
    </li>
    <li class="list-group-item d-flex justify-content-between align-items-center">
      Agendamento realizado
      <span class="badge bg-{{ agendamentos|length > 0 and 'success' or 'secondary' }}">
        {{ '✔️' if agendamentos|length > 0 else '❌' }}
      </span>
    </li>
    <li class="list-group-item d-flex justify-content-between align-items-center">
      Vistoria feita
      <span class="badge bg-{{ vistorias|length > 0 and 'success' or 'secondary' }}">
        {{ '✔️' if vistorias|length > 0 else '❌' }}
      </span>
    </li>
  </ul>

  <!-- Barra de Progresso -->
  {% set etapas_concluidas = (comunicacoes|length > 0)|int + (agendamentos|length > 0)|int + (vistorias|length > 0)|int %}
  {% set progresso = (etapas_concluidas / 3) * 100 %}
  <div class="mb-4">
    <label class="form-label">Progresso da obra:</label>
    <div class="progress">
      <div class="progress-bar bg-info" role="progressbar" style="width: {{ progresso }}%">
        {{ progresso|round(0) }}%
      </div>
    </div>
  </div>

  <!-- Cards -->
  <div class="row">
    <!-- Vistorias -->
    <div class="col-md-4 col-12 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-primary text-white">Vistorias</div>
        <div class="card-body">
          {% if vistorias %}
            <ul class="list-group list-group-flush">
              {% for vistoria in vistorias %}
              <li class="list-group-item">
                {{ vistoria.data_1.strftime('%d/%m/%Y') if vistoria.data_1 else "Data não informada" }} - {{ vistoria.rua }}
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>Nenhuma vistoria registrada.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Agendamentos -->
    <div class="col-md-4 col-12 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-success text-white">Agendamentos</div>
        <div class="card-body">
          {% if agendamentos %}
            <ul class="list-group list-group-flush">
              {% for ag in agendamentos %}
              <li class="list-group-item">
                {{ ag.data_agendada.strftime('%d/%m/%Y') }} - {{ ag.nome_morador }}
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>Nenhum agendamento registrado.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Comunicações -->
    <div class="col-md-4 col-12 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-warning text-dark">Comunicações</div>
        <div class="card-body">
          {% if comunicacoes %}
            <ul class="list-group list-group-flush">
              {% for c in comunicacoes %}
              <li class="list-group-item">{{ c.nome }} - {{ c.endereco }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p>Sem comunicações registradas.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <a href="{{ url_for('obras') }}" class="btn btn-secondary mt-3">← Voltar</a>
</div>
{% endblock %}
