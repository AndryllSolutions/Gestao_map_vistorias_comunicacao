<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Comunica√ß√µes por Obra</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .obra-bloco {
        border-left: 4px solid #0d6efd;
        padding-left: 12px;
      }
    </style>
  </head>
  <body class="bg-light p-3 p-md-4">
    <div class="container bg-white p-4 rounded shadow">
      <div
        class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2"
      >
        <h3 class="text-center text-md-start mb-0">üìÇ Comunica√ß√µes por Obra</h3>

        {% if session.cargo == 'admin' %}
        <input
          type="text"
          class="form-control w-100 w-md-auto"
          id="filtroObra"
          placeholder="üîç Filtrar obra por nome..."
          style="max-width: 300px"
        />
        {% endif %}
      </div>

      <div class="mb-3">
            <a href="{{ url_for('auth.dashboard') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
        </a>
      </div>

      {% for obra in obras %}
      <div class="obra-bloco mb-4" data-obra="{{ obra.nome | lower }}">
        <h5 class="mt-3">üèóÔ∏è Obra: {{ obra.nome }}</h5>

        {% if obra.comunicacoes %}
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle text-center">
            <thead class="table-light">
              <tr>
                <th>Nome</th>
                <th>Endere√ßo</th>
                <th>Tipo</th>
                <th>Via</th>
                <th>Telefone</th>
                <th>CPF</th>
                <th>Economia</th>
                <th>Data</th>
                {% if session.cargo == 'admin' %}
                <th>A√ß√µes</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for r in obra.comunicacoes %}
              <tr>
                <td>{{ r.nome }}</td>
                <td>{{ r.endereco }}</td>
                <td>{{ r.tipo_imovel }}</td>
                <td>{{ r.comunicado }}</td>
                <td>{{ r.telefone }}</td>
                <td>{{ r.cpf }}</td>
                <td>{{ r.economia }}</td>
                <td>{{ r.data_envio.strftime('%d/%m/%Y') }}</td>
                {% if session.cargo == 'admin' %}
                <td>
                  <a
                    href="{{ url_for('obras.editar_comunicacao', id=r.id) }}"

                    class="btn btn-sm btn-primary"
                  >
                    <i class="bi bi-pencil"></i>
                  </a>
                  <form
                    method="POST"
                    action="{{ url_for('obras.excluir_comunicacao', id=r.id) }}"

                    class="d-inline"
                    onsubmit="return confirm('Confirmar exclus√£o?')"
                  >
                    <button class="btn btn-sm btn-danger">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted">Nenhuma comunica√ß√£o cadastrada para esta obra.</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <script>
      // Filtro de obra por nome
      const input = document.getElementById("filtroObra");
      if (input) {
        input.addEventListener("input", () => {
          const termo = input.value.toLowerCase();
          document.querySelectorAll(".obra-bloco").forEach((bloco) => {
            const nome = bloco.getAttribute("data-obra");
            bloco.style.display = nome.includes(termo) ? "" : "none";
          });
        });
      }
    </script>
  </body>
</html>
